<!DOCTYPE html>
<html>
  <head>
    <title>
        Prosody - Editor
    </title>
    <link rel="stylesheet" href="CSS/UI.css">
    <style>
        
        #map-editor {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            width: 20rem;
            margin-left: auto;
            margin-right: auto;
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid #888;
            position: fixed;
            bottom:0%;
            transform: rotate(180deg);
        }
        
        #EditorContainer {
            width: 15%;
            height: 100%;
            margin: auto;
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid #888;
            position: relative;
            
        }

        .grid-cell {
            border: 1px solid #ccc;
            margin-top: -2px;
        }

        .note {
            background-image: url("Sprites/Notes/Note_Hit_1.png");
            background-repeat: no-repeat;
            background-size: contain;
            background-position-x: center;
        }
        

        input {
            width: auto;
            height: 1.5625rem;
            border-radius: 0.625rem;
            font-size: 0.625rem;
        }

        

    </style>
  </head>
  <body>
    <div id="BGContainer" style="position:absolute; background-color: rgba(0, 0, 0, 0.5); z-index: -5; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <img id="BGDim" class="background" style="position: absolute; z-index: -7; margin: 0 auto; width: 100%; background-color: inherit;" src="Sprites/Background/Dim.png" />
        <img id="BGCenter" class="background" style="position: absolute; z-index: -8; margin: 0 auto; width: 80%;" src="Sprites/Background/Center.png" />
        <img id="BGPattern" class="background" style="position: absolute; z-index: -9; margin: 0 auto; width: 120%;" src="Sprites/Background/Pattern.png" />
        <img id="BGGradient" class="background" style="position: absolute; z-index: -10; margin: 0 auto; width: 100%;" src="Sprites/Background/Gradient.png" />
    </div>
    <div id="HitBar" style="width: 20rem; height: 0.5rem; background-color: rgba(226, 57, 49, 0.75); position:absolute; bottom: 0; margin-left: calc(50% - 9rem);">
    </div>
    <div id="EditorContainer">
        <div id="map-editor">
        </div>
    </div>
    <script> 
        // Get the map editor container
        const mapEditor = document.querySelector('#map-editor');
        let offsetY = 0;
        let offset
        let audio = 0;
        let mapLength = 0;
        let BPM = 0;

        let file;

        let Json = {
            "Name": "???",
            "Audio": "???",
            "SongArtist": "???",
            "Creator": "???",
            "BPM": 60,
            "BG": {
                "BG":"Sprites/Background/BG.png",
                "Gradient":"Sprites/Background/Gradient.png",
                "Pattern":"Sprites/Background/Pattern.png",
                "Center":"Sprites/Background/Center.png"
            },
            "4Rows": {
                "Difficulty1": {
                    "Map Name": "???",
                    "Offset": 0,
                    "Notes":[[],[],[],[]]
                }
            }
        }

        // Toggle note placement on click
        function toggleNote(event) {
            const cell = event.target;
            toggleCell(cell);
        }

        function toggleCell(cell, _loaded = false) {
            cell.classList.toggle('note');

            const row = cell.getAttribute('data-row');
            const col = 3 - cell.getAttribute('data-col');
            console.log(`Note at row ${row}, column ${col} is ${cell.classList.contains('note') ? 'on' : 'off'}.`);

            const index = Json["4Rows"]["Difficulty1"]["Notes"][col].indexOf(parseInt(row)/4);
            cell.classList.contains('note') ? Json["4Rows"]["Difficulty1"]["Notes"][col].push(parseInt(row)/4) : Json["4Rows"]["Difficulty1"]["Notes"][col].splice(index,1);

            Json["4Rows"]["Difficulty1"]["Notes"][col].sort(function(a, b){
                return a - b;
            });

            UpdateChartJson()
        }

        function UpdateChartJson() {
            try {
                Json["Audio"] = document.getElementById("MDPreAudio").value;
            } catch (error) { }
            Json["Name"] = document.getElementById("MDChartName").value;
            Json["SongArtist"] = document.getElementById("MDArtist").value;
            Json["Creator"] = document.getElementById("MDCreator").value;
            Json["BPM"] = document.getElementById("MDBPM").value;
            Json["4Rows"]["Difficulty1"]["Offset"] = document.getElementById("MDOffset").value;

            //document.getElementById("OptionChartData").innerHTML = JSON.stringify(Json);
            document.getElementById("ChartDiff").innerHTML = calculateDifficulty(Json, 1);
        }

        function play() {
            audio.play();
        }

        function pause() {
            audio.pause();
        }

        window.onload = function() {
            // Updates the game, basically the play
            function Update() {
                if (audio != null) {
                    //mapEditor.style.transform = `rotate(180deg) translateY(${(-audio.currentTime*BPM*4+BPM*offset)/16}rem)`;
                    mapEditor.style.bottom = `${(-audio.currentTime*468+BPM*offset*4)/16}rem`;
                    //document.getElementById("HitBar").style.transform = `translateY(${(audio.currentTime*BPM*4)/16}rem)`;
                }
            }
            setInterval(Update, 1000/240)
            if (!blob) {
                console.log('Your browser does not support Blob URLs :(');     
            }

            document.getElementById('MDAudio').addEventListener('change', function(event){
                document.getElementById('MDPreAudio').value = "Custom"
                console.log('change on input#file triggered');
                file = this.files[0],
                fileURL = blob.createObjectURL(file);
                console.log(file);
                console.log('File name: '+file.name);
                if (document.getElementById("MDChartName").value == "") {
                    document.getElementById("MDChartName").value = file.name
                }
                console.log('File type: '+file.type);
                console.log('File BlobURL: '+ fileURL);
                document.getElementById('audio').src = fileURL;
                setTimeout(() => {
                    ReloadChart();
                }, 100);
            });
            
            document.getElementById('MDPreAudio').addEventListener('change', function(){
                console.log(`${this.value}`);
                console.log('File name: '+this.value);
                file = this.value;
                fileURL = this.value;
                console.log('File type: mp3');
                document.getElementById('audio').src = this.value;

                switch (this.value.split('/')[1]) {
                    case "Inaji-The_Pathbreaking.mp3":
                            document.getElementById("MDChartName").value = "The Pathbreaking"
                            document.getElementById("MDBPM").value = 120;
                            BPM = 120;
                            document.getElementById("MDOffset").value = 2.07;
                            document.getElementById("MDArtist").value = "Inaji";
                        break;
                    case "Cyberspace Abyss.mp3":
                            document.getElementById("MDChartName").value = "Cyberspace Abyss"
                            document.getElementById("MDBPM").value = 170;
                            BPM = 170;
                            document.getElementById("MDOffset").value = 0;
                            document.getElementById("MDArtist").value = "Cyphe Mercury";
                        break;
                
                    default:
                        break;
                }
                setTimeout(() => {
                    ReloadChart();
                }, 100);
            });
        }

        document.body.onkeyup = function(e) {
            if (e.key == " " || e.code == "Space" || e.keyCode == 32 ) {
                if (!audio.paused) {
                    pause();
                    return;
                }
                play();
            }
        }

        addEventListener("wheel", (event) => {
            audio.currentTime += event.deltaY/BPM/audio.duration*10;
        });
        

        var blob = window.URL || window.webkitURL;
        
        function ReloadChart() {
            if (audio != 0) {
                pause()
            }
            audio = document.getElementById("audio");

            RemoveAllTiles();
            Json['4Rows']['Difficulty1']['Notes']= [[],[],[],[]]

            offset = document.getElementById("MDOffset").value;
            BPM = parseInt(document.getElementById("MDBPM").value);
            mapLength = audio.duration

            AppendTiles(BPM*mapLength);
            // Create the grid cells
        }

        async function LoadJson(_Chart) {

            //Conver file Json to editor Json

            //Json = JSON.parse(document.getElementById("OptionChartData").innerHTML)
            let reader = new FileReader();
            reader.readAsText(_Chart);

            reader.onload = function() {
                const _chart = JSON.parse(reader.result)
                document.getElementById("MDChartName").value = _chart["Name"];
                document.getElementById("MDArtist").value = _chart["SongArtist"];
                document.getElementById("MDCreator").value = _chart["Creator"];
                document.getElementById("MDBPM").value = _chart["BPM"];
                document.getElementById("MDOffset").value = _chart["4Rows"]["Difficulty1"]["Offset"];
                document.getElementById('audio').src = _chart["Audio"];

                document.getElementById("BGBGCenter").src

                setTimeout(() => {
                    ReloadChart()
                    setTimeout(() => {
                        LoadNotes(_chart["4Rows"]["Difficulty1"]["Notes"])
                    }, 3000);
                }, 100);
            };
        }

        function RemoveAllTiles() {
            var cells = document.getElementsByClassName('grid-cell');

            while(cells[0]) {
                cells[0].parentNode.removeChild(cells[0]);
            }
        }

        function AppendTiles(_AMNT) {
            for (let i = 0; i < _AMNT; i++) {
                const cell = document.createElement('div');
                cell.classList.add('grid-cell');
                cell.addEventListener('click', toggleNote);
                cell.setAttribute('data-row', Math.floor(i / 4));
                cell.setAttribute('data-col', i % 4);
                if (Math.floor(i / 4) % 4 === 0 ) {
                    cell.style.border = '1px solid #000';
                }
                mapEditor.appendChild(cell);
            }
            UpdateTileHeight(BPM)
        }

        function LoadNotes(_Notes) {
            console.log("Loading chart")
            console.log(_Notes)
            for (let _NoteX = 0; _NoteX < _Notes.length; _NoteX++) { // Cycles threw each lane [],[],[],[]
                const _XNotes = document.querySelectorAll(`div[data-col='${-_NoteX+3}']`) // Gets all the editor tiles with that lane
                for (let _NoteY = 0; _NoteY < _Notes[_NoteX].length; _NoteY++) { // Cycles threw all the notes
                    for (let i = 0; i < _XNotes.length; i++) {
                        const element = _XNotes[i];
                        if (element.getAttribute("data-row") == _Notes[_NoteX][_NoteY]*4) {
                            toggleCell(element)
                            break;
                        }
                    }
                }
            }
        }

        function UpdateTileHeight(_BPM) {
            var _Tiles = document.getElementsByClassName("grid-cell");
            for (let i = 0; i < _Tiles.length; i++) {
                _Tiles[i].style.height = 7030/_BPM+"px"
                
            }
        }
        window.onkeydown = function(e) {
            switch (e.keyCode) {
                case 27: 
                    document.getElementById("ExitMenu").style.display = (document.getElementById("ExitMenu").style.display == "none") ? "block" : "none";
                    //location.href = 'index.html';
                    break
            
                default:
                    console.log(e.keyCode)
                    break;
            }
        }

        function convertImageToBase64(imgUrl, loc) {
            const image = new Image();
            image.crossOrigin='anonymous';
            image.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = image.naturalHeight;
                canvas.width = image.naturalWidth;
                ctx.drawImage(image, 0, 0);
                const dataUrl = canvas.toDataURL();
                //callback && callback(dataUrl)
                Json['BG'][loc] = dataUrl;
            }
            image.src = imgUrl;
        }
    </script>
    <div id="MappingInfo" class = "UIContainer" style="width:20%; float: left; height: 50rem; max-height: 70%; overflow-y: scroll;">
        <div id="Header">
            <p>
                Mapping
            </p>
        </div>
        <div class = "UIContainer">
            <div>
                <a>
                    Mapping Data:
                </a>
            </div>
            <label>Song: </label>

            <div class="UIContainer">
                <label for="songs">Pre-Songs:</label>

                <select id="MDPreAudio" name="songs" onchange="{UpdateChartJson(); Json['4Rows']['Difficulty1']['Notes']= [[],[],[],[]] }" id="songs">
                    <option value="Custom">Custom</option>
                    <option value="Audio/Inaji-The_Pathbreaking.mp3">Inaji - The Pathbreaking</option>
                    <option value="Audio/Cyberspace Abyss.mp3">Cyphe Mercury - Cyberspace Abyss</option>
                </select>
                <input id="MDAudio" onchange="{Json['4Rows']['Difficulty1']['Notes']= [[],[],[],[]]; UpdateChartJson(); }" type="file" accept="audio/mp3"> <label>Not fully supported</label><br>
            </div>
            <label>BPM: </label>
            <input id="MDBPM" onchange="ReloadChart()" type="number" value="60"> <br>
            <label>Offset: </label>
            <input id="MDOffset" onchange="ReloadChart()" type="text"> <br>
        </div>
        <div class = "UIContainer">
            <div>
                <a>
                    Preview:
                </a>
            </div>
            <label>Chart Title: </label>
            <input id="MDChartName" onchange="UpdateChartJson()" type="text"> <br>
            <label>Artist: </label>
            <input id="MDArtist" onchange="UpdateChartJson()" type="text"> <br>
            <label>Creator: </label>
            <input id="MDCreator" onchange="UpdateChartJson()" type="text"> <br>

            <label>Audio Preview: WIP</label>
            <input id="ChartPreview" onchange="UpdateChartJson()" type="number"> <button onclick="{document.getElementById('ChartPreview').value = (audio.src != null) ? audio.currentTime : 0}">Set Current Time Stamp</button> <br>
            <label>Icon: WIP </label>
            <input id="InpIcon" onchange="{var BGCenter = blob.createObjectURL(this.files[0]); document.getElementById('BGCenter').src = BGCenter; convertImageToBase64(BGCenter, 'Center'); UpdateChartJson();}" type="file" accept="image/png, image/gif, image/jpeg"> <br>
            <div class="UIContainer">
                <div>
                    <a>
                        Info Panel WIP
                    </a>
                </div>
                <label>Banner: </label>
                <input id="InpBanner" onchange="{var BGCenter = blob.createObjectURL(this.files[0]); document.getElementById('BGCenter').src = BGCenter; convertImageToBase64(BGCenter, 'Center'); UpdateChartJson();}" type="file" accept="image/png, image/gif, image/jpeg"> <br>
                <label>Description: </label>
                <span id="InpDesc" class="textarea" role="textbox" contenteditable>
                            
                </span> <br>
                <label>Tags: (Sepparated by space) </label>
                <span id="InpTags" class="textarea" role="textbox" contenteditable>
                            
                </span> <br>
                <label>Source: </label>
                <input id="InpSource" onchange="UpdateChartJson()" type="text"> <br>
            </div>
        </div>
        <div class = "UIContainer">
            <div>
                <a>
                    Background:
                </a>
            </div>
            <label>Main Background:
                <input id="BGBG" onchange="{var BG = blob.createObjectURL(this.files[0]); document.getElementById('BG').src = BG; convertImageToBase64(BG, 'BG'); UpdateChartJson();}" type="file" accept="image/png, image/gif, image/jpeg"> <br>
            </label>
            <label>BG Twist: (Optional)</label>
            <div class="UIContainer">
                (Feature may be removed in the future)
                <br>
                <label>
                    Center: 
                    <input id="BGBGCenter" onchange="{var BGCenter = blob.createObjectURL(this.files[0]); document.getElementById('BGCenter').src = BGCenter; convertImageToBase64(BGCenter, 'Center'); UpdateChartJson();}" type="file" accept="image/png, image/gif, image/jpeg"> <br>
                </label>
                <label>
                    Pattern: 
                    <input id="BGBGPattern" onchange="{var BGPattern = blob.createObjectURL(this.files[0]); document.getElementById('BGPattern').src = BGPattern; convertImageToBase64(BGPattern, 'Pattern'); UpdateChartJson();}" type="file" accept="image/png, image/gif, image/jpeg"> <br>
                </label>
                <label>
                    Gradient: 
                    <input id="BGBGGradient" onchange="{var BGGradient = blob.createObjectURL(this.files[0]); document.getElementById('BGGradient').src = BGGradient; convertImageToBase64(BGGradient, 'Gradient'); UpdateChartJson();}" type="file" accept="image/png, image/gif, image/jpeg"> <br>
                </label>
            </div>
        </div>
        <div class="UIContainer">
            <div>
                <a>
                    Difficulty:
                </a>
            </div>
            <br>
            <label id="ChartDiff"></label>
        </div>
    </div>
    
    <div id="MappingData" class="UIContainer"  style="width:20%; float: right;">
        <div>
            <p>
                Export/Import:
            </p>
        </div>
        <!--<button onclick="JsonToChart()">Load</button>-->
        <label>
            Import chart: 
            <input type="file" onchange="{var ImportedChart = this.files[0]; LoadJson(ImportedChart); UpdateChartJson();}" accept=".psdc"></input>
        </label>
        <hr>
        <label>
            Export chart:
            <button onclick="download(`Chart_${Date.now()}.psdc`,JSON.stringify(Json))">Download Chart</button>
        </label>
    </div>
    
    <audio id="audio" style="position: absolute; bottom: 0; left: 0; float: left;" controls></audio><br>
    <button id="audio" style="position: absolute; bottom: 0; right: 0; width: 10rem; height:2.5rem;" onclick="{localStorage['Chart'] = JSON.stringify(Json); window.open('game.html', '_blank');}">Test Chart</button><br>
    
    <div id="ExitMenu" class="modal" style="display:none; position: absolute; width: 100%;">
        <div class="modal-content">
            <div class="UIContainer" style="background-color: rgba(0, 0, 0, 0.8); width: 97.5%;">
                <a>
                    Are you sure you want to exit?
                </a>
                <br>
                <p>
                    Press 'esc' to close this window.
                <br>
                    Make sure you copy your JSON code for your map and save it into a file so you don't lose it.
                <br>
                    Currently you can only load charts in the JSON expirimental features in the game
                </p>
                <div class="UIContainer" style="background-color: rgba(56, 56, 56, 0.4);">
                    <button onclick="{location.href = 'index.html'}" style=" width: 5rem; height: 3rem;">
                        Exit
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Set Json audio
        const fileInput = document.getElementById("MDAudio");

        // Listen for the change event so we can capture the file
        fileInput.addEventListener('change', (e) => {
            // Get a reference to the file
            const file = e.target.files[0];

            // Encode the file using the FileReader API
            const reader = new FileReader();
            reader.onloadend = () => {
                Json["Audio"] = reader.result;
            };
            reader.readAsDataURL(file);
        });
    </script>
    <script>
        // Download the chart shown in editor.
        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
    </script>
    <script src="Scripts/DifficultyCalculator.js"></script>
  </body>
</html>